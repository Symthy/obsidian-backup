

https://speakerdeck.com/mixi_engineers/2022-database-training

# エンコーディング

インメモリの表現からバイト並びへの変換
- メモリ内のデータの持ち方と、メモリ外のデータの持ち方は異なる

標準化されたフォーマット
- テキストフォーマット：Json、XML、CSV
	- テキストのためデータは大きくなりがち
	- スキーマは組み込まれていない（好きなスキーマで格納できるが、複数組織で合意形成が必要）
- バイナリフォーマット：Thirft、Protocol Buffers、Avro
	- スキーマを必要とするエンコーディング
		- スキーマ情報は、ドキュメントやコードの自動生成にも利用可能

## テラバイト級のデータを扱うためのデータエンコーディング
- Apache Thrift  (Facebook)
- Protocol Buffers
- Apache Avro

# 分散データの取り扱い

## レプリケーション

レプリケーションとは、ハードウェアを含め同じシステム環境が2セット（稼働系と待機系）用意された環境において リアルタイムにデータをもう一方の環境に複製する技術です。万が一、稼働系に障害が発生した時にも、待機系に切り替えるだけで業務を継続することができ
ref: [3分で学ぶ！レプリケーションとは？バックアップと何が違う？](https://bcblog.sios.jp/what-is-replication/)

目的
- レイテンシ（転送要求を出してから実際にデータが送られてくるまでに生じる通信の遅延時間）を下げる
- 障害があってもシステムを動作させる（可用性を向上）
- スケールアウトさせる（スループット向上）

トレードオフ
- 同期的か、非同期的か
- 障害を起こしたレプリカの扱いをどうするか

## パーティショニング

目的：
- スケーラビリティ向上が目的
	- クエリ負荷分散
- 良いパーティショニングは、データとクエリの負荷をノード間で均等に分散させる
	- 偏りがある状態＝skew
	- 負荷集中しているパーティション＝ホットスポット
ref:[データベース基礎編（ミクシィ22新卒技術研修）](https://speakerdeck.com/mixi_engineers/2022-database-training)

上記は 水平スケーラビリティ（シャーディング）のこと

パーティショニングは大きく２つ
- テーブル間の分割  (１DB内の話？)
- ノード間の分割 

DBによっても特徴が異なる
- Postgres 
	- 欠点
> PostgreSQL はパーティショニング専用の組み込み機能を持たず、複数のテーブル／継承／CHECK 制約などを組み合わせて実現しています。それが災いし、パーティショニングを行うと性能や機能が低下する場合がある
> ref : [パーティショニング : 用途と利点](https://lets.postgresql.jp/documents/technical/partitioning/1)


- データ分割理由
- スケーラビリティのためのパーティションの設計
- クエリ パフォーマンスのためのパーティションの設計
- 可用性のためのパーティションの設計
以下参照
ref: [(Azure) データパーティショニングのガイダンス](https://github.com/Huachao/azure-content/blob/master/articles/best-practices-data-partitioning.md)
パーティション設計
- 水平パーティション（シャーディング）：すべてのパーティションが同じスキーマ。連続する範囲のシャードキー（例：A～G と H～Z）のデータを分けて格納
- 垂直パーティション：アクセス頻度の高いフィールドと低いフィールドで分割（テーブル自体を分ける）
- 機能分割：ビジネス機能でデータを別々のパーティションに格納

※データベース指向アプリケーションデザイン を読んだ方がいい

## トランジション

複数の読み書きを１つの論理的な単位としてまとめる方法
- 「プログラミングモデルをシンプルにする」という目的で生まれた
- 全体として成功か失敗か

トランザクション分離レベル
- Read Commited
	- ダーティリード（コミットされていないデータが読めてしまう）、ダーティライト（コミットされていないデータを上書き）が発生しないことを保証
- Snapshot Isolation (Repeatable Read)
	- トランザクション中に  他トランザクションによる変更を読み取らないこと  を保証
	- nonrepeatable read (read skew) が発生しない
- Serializable
		- すべての更新不整合を回避。ただしパフォーマンスは悪い


#DB
#分散データ
